From: Markus Koschany <apo@debian.org>
Date: Thu, 7 Mar 2019 14:18:42 +0100
Subject: CVE-2018-20481

Bug-Upstream: https://gitlab.freedesktop.org/poppler/poppler/issues/692
Bug-Debian: https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=917325
Origin: https://gitlab.freedesktop.org/poppler/poppler/merge_requests/143/diffs?commit_id=39a251b1b3a3343400a08e2f03c5518a26624626
---
 poppler/XRef.cc | 28 ++++++++++++++++++++++------
 1 file changed, 22 insertions(+), 6 deletions(-)

diff --git a/poppler/XRef.cc b/poppler/XRef.cc
index c652f5b..917e583 100644
--- a/poppler/XRef.cc
+++ b/poppler/XRef.cc
@@ -1626,11 +1626,32 @@ void XRef::readXRefUntil(int untilEntryNum, std::vector<int> *xrefStreamObjsNum)
   }
 }
 
+namespace {
+
+struct DummyXRefEntry : XRefEntry {
+  DummyXRefEntry() {
+    offset = 0;
+    gen = -1;
+    type = xrefEntryNone;
+    flags = 0;
+  }
+};
+
+DummyXRefEntry dummyXRefEntry;
+
+}
+
+
 XRefEntry *XRef::getEntry(int i, GBool complainIfMissing)
 {
   if (entries[i].type == xrefEntryNone) {
 
     if ((!xRefStream) && mainXRefEntriesOffset) {
+      if (unlikely(i >= capacity)) {
+        error(errInternal, -1, "Request for out-of-bounds XRef entry [{0:d}]", i);
+        return &dummyXRefEntry;
+      }
+
       if (!parseEntry(mainXRefEntriesOffset + 20*i, &entries[i])) {
         error(errSyntaxError, -1, "Failed to parse XRef entry [{0:d}].", i);
       }
@@ -1641,12 +1662,7 @@ XRefEntry *XRef::getEntry(int i, GBool complainIfMissing)
       // We might have reconstructed the xref
       // Check again i is in bounds
       if (unlikely(i >= size)) {
-        static XRefEntry dummy;
-        dummy.offset = 0;
-        dummy.gen = -1;
-        dummy.type = xrefEntryNone;
-        dummy.flags = 0;
-        return &dummy;
+	return &dummyXRefEntry;
       }
 
       if (entries[i].type == xrefEntryNone) {
