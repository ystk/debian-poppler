From: Markus Koschany <apo@debian.org>
Date: Thu, 7 Mar 2019 14:40:08 +0100
Subject: CVE-2018-20662

Bug-Upstream: https://gitlab.freedesktop.org/poppler/poppler/issues/706
Bug-Debian: https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=918158
Origin: https://gitlab.freedesktop.org/poppler/poppler/commit/7b4e372deeb716eb3fe3a54b31ed41af759224f9
---
 utils/pdfunite.cc | 27 +++++++++++++++++++++------
 1 file changed, 21 insertions(+), 6 deletions(-)

diff --git a/utils/pdfunite.cc b/utils/pdfunite.cc
index b53e497..e26c149 100644
--- a/utils/pdfunite.cc
+++ b/utils/pdfunite.cc
@@ -48,7 +48,7 @@ int main (int argc, char *argv[])
   Guint numOffset = 0;
   std::vector<Object> pages;
   std::vector<Guint> offsets;
-  XRef *yRef, *countRef;
+  XRef *yRef, *countRef, *xref;
   FILE *f;
   OutStream *outStr;
   int i;
@@ -58,6 +58,7 @@ int main (int argc, char *argv[])
   int minorVersion = 0;
   char *fileName = argv[argc - 1];
   int exitCode;
+  Object catDict;
 
   exitCode = 99;
   const GBool ok = parseArgs (argDesc, &argc, argv);
@@ -79,7 +80,11 @@ int main (int argc, char *argv[])
   for (i = 1; i < argc - 1; i++) {
     GooString *gfileName = new GooString(argv[i]);
     PDFDoc *doc = new PDFDoc(gfileName, NULL, NULL, NULL);
-    if (doc->isOk() && !doc->isEncrypted()) {
+    xref = new XRef();
+    xref = doc->getXRef();
+    xref->getCatalog(&catDict);
+    if (doc->isOk() && !doc->isEncrypted() &&
+            catDict.isDict()) {
       docs.push_back(doc);
       if (doc->getPDFMajorVersion() > majorVersion) {
         majorVersion = doc->getPDFMajorVersion();
@@ -90,8 +95,13 @@ int main (int argc, char *argv[])
         }
       }
     } else if (doc->isOk()) {
-      error(errUnimplemented, -1, "Could not merge encrypted files ('{0:s}')", argv[i]);
-      return -1;
+      if (doc->isEncrypted()) {
+        error(errUnimplemented, -1, "Could not merge encrypted files ('{0:s}')", argv[i]);
+        return -1;
+      } else if (!catDict.isDict()) {
+        error(errSyntaxError, -1, "XRef's Catalog is not a dictionary ('{0:s}')", argv[i]);
+        return -1;
+      }
     } else {
       error(errSyntaxError, -1, "Could not merge damaged documents ('{0:s}')", argv[i]);
       return -1;
@@ -112,8 +122,13 @@ int main (int argc, char *argv[])
   for (i = 0; i < (int) docs.size(); i++) {
     for (j = 1; j <= docs[i]->getNumPages(); j++) {
       PDFRectangle *cropBox = NULL;
-      if (docs[i]->getCatalog()->getPage(j)->isCropped())
-        cropBox = docs[i]->getCatalog()->getPage(j)->getCropBox();
+      if (!docs[i]->getCatalog()->getPage(j) == NULL) {
+          if (docs[i]->getCatalog()->getPage(j)->isCropped())
+            cropBox = docs[i]->getCatalog()->getPage(j)->getCropBox();
+      }
+      else {
+          return -1;
+      }
       docs[i]->replacePageDict(j,
 	    docs[i]->getCatalog()->getPage(j)->getRotate(),
 	    docs[i]->getCatalog()->getPage(j)->getMediaBox(), cropBox, NULL);
