From e16f2d5bf39842c647d413bbd6e16de73c76a2c8 Mon Sep 17 00:00:00 2001
From: Marek Kasik <mkasik@redhat.com>
Date: Mon, 22 Oct 2018 16:56:01 +0200
Subject: [PATCH] Avoid cycles in PDF parsing

Mark objects being processed in Parser::makeStream() as being processed
and check the mark when entering this method to avoid processing
of the same object recursively.
---
 poppler/Parser.cc | 15 +++++++++++++++
 poppler/XRef.h    |  1 +
 2 files changed, 16 insertions(+)

--- a/poppler/Parser.cc
+++ b/poppler/Parser.cc
@@ -197,6 +197,18 @@
   Stream *str;
   Goffset length;
   Goffset pos, endPos;
+  XRefEntry *entry;
+
+  if (xref && (entry = xref->getEntry(objNum, gFalse))) {
+    if (!entry->getFlag(XRefEntry::Parsing) ||
+        (objNum == 0 && objGen == 0)) {
+      entry->setFlag(XRefEntry::Parsing, gTrue);
+    } else {
+      error(errSyntaxError, getPos(),
+            "Object '{0:d} {1:d} obj' is being already parsed", objNum, objGen);
+      return NULL;
+    }
+  }
 
   // get stream start position
   lexer->skipToNextLine();
@@ -276,6 +288,9 @@
   // get filters
   str = str->addFilters(dict, recursion);
 
+  if (entry)
+    entry->setFlag(XRefEntry::Parsing, gFalse);
+
   return str;
 }
 
--- a/poppler/XRef.h
+++ b/poppler/XRef.h
@@ -69,6 +69,7 @@
   enum Flag {
     // Regular flags
     Updated,     // Entry was modified
+    Parsing,     // Entry is currently being parsed
 
     // Special flags -- available only after xref->scanSpecialFlags() is run
     Unencrypted, // Entry is stored in unencrypted form (meaningless in unencrypted documents)
