From: Markus Koschany <apo@debian.org>
Date: Wed, 28 Sep 2022 20:53:41 +0200
Subject: CVE-2022-38784

Bug-Debian: https://bugs.debian.org/1018971
Origin: https://gitlab.freedesktop.org/poppler/poppler/-/commit/27354e9d9696ee2bc063910a6c9a6b27c5184a52
---
 poppler/JBIG2Stream.cc | 19 ++++++++++++++++++-
 1 file changed, 18 insertions(+), 1 deletion(-)

diff --git a/poppler/JBIG2Stream.cc b/poppler/JBIG2Stream.cc
index ca14a59..0a0048f 100644
--- a/poppler/JBIG2Stream.cc
+++ b/poppler/JBIG2Stream.cc
@@ -44,6 +44,19 @@
 //~ share these tables
 #include "Stream-CCITT.h"
 
+#include <climits>
+
+#ifndef __has_builtin
+  #define __has_builtin(x) 0
+#endif
+
+template<typename T>
+inline bool checkedAdd(T x, T y, T *z) {
+#if __GNUC__ >= 5 || __has_builtin(__builtin_add_overflow)
+  return __builtin_add_overflow(x, y, z);
+#endif
+}
+
 //------------------------------------------------------------------------
 
 static const int contextSize[4] = { 16, 13, 10, 10 };
@@ -2070,7 +2083,11 @@ void JBIG2Stream::readTextRegionSeg(Guint segNum, GBool imm,
   for (i = 0; i < nRefSegs; ++i) {
     if ((seg = findSegment(refSegs[i]))) {
       if (seg->getType() == jbig2SegSymbolDict) {
-	numSyms += ((JBIG2SymbolDict *)seg)->getSize();
+          Guint segSize = ((JBIG2SymbolDict *)seg)->getSize();
+          if (unlikely(checkedAdd(numSyms, segSize, &numSyms))) {
+               error(errSyntaxError, getPos(), "Too many symbols in JBIG2 text region");
+               return;
+          }
       } else if (seg->getType() == jbig2SegCodeTable) {
 	codeTables->append(seg);
       }
