From: Markus Koschany <apo@debian.org>
Date: Wed, 28 Sep 2022 20:48:55 +0200
Subject: CVE-2018-18897

Bug-Debian: https://bugs.debian.org/913164
Origin: https://gitlab.freedesktop.org/poppler/poppler/commit/e07c8b4784234383cb5ddcf1133ea91a772506e2
---
 poppler/GfxState.cc   | 9 +++++++++
 qt5/src/poppler-qt5.h | 4 ++++
 2 files changed, 13 insertions(+)

diff --git a/poppler/GfxState.cc b/poppler/GfxState.cc
index 0e0de48..df516be 100644
--- a/poppler/GfxState.cc
+++ b/poppler/GfxState.cc
@@ -234,6 +234,10 @@ static unsigned int getCMSNChannels(cmsColorSpaceSignature cs);
 static cmsHPROFILE loadColorProfile(const char *fileName);
 
 void GfxColorSpace::setDisplayProfile(void *displayProfileA) {
+  if (displayProfile != NULL) {
+    error(errInternal, -1, "The display color profile can only be set once before any rendering is done.");
+    return;
+  }
   displayProfile = displayProfileA;
   if (displayProfile != NULL) {
     cmsHTRANSFORM transform;
@@ -257,6 +261,11 @@ void GfxColorSpace::setDisplayProfile(void *displayProfileA) {
 }
 
 void GfxColorSpace::setDisplayProfileName(GooString *name) {
+  if (displayProfile != NULL) {
+    error(errInternal, -1, "The display color profile can only be set before any rendering is done.");
+    return;
+  }
+  delete displayProfileName;
   displayProfileName = name->copy();
 }
 
diff --git a/qt5/src/poppler-qt5.h b/qt5/src/poppler-qt5.h
index 6f36088..477ff16 100644
--- a/qt5/src/poppler-qt5.h
+++ b/qt5/src/poppler-qt5.h
@@ -859,6 +859,8 @@ delete it;
 
 	  \param outputProfileA is a \c cmsHPROFILE of the LCMS library.
 
+	  \note This should be called before any rendering happens and only once during the lifetime of the current process.
+
 	   \since 0.12
 	*/
 	void setColorDisplayProfile(void *outputProfileA);
@@ -867,6 +869,8 @@ delete it;
 
 	  \param name is the name of the display profile to set.
 
+	  \note This should be called before any rendering happens.
+
 	   \since 0.12
 	*/
 	void setColorDisplayProfileName(const QString &name);
