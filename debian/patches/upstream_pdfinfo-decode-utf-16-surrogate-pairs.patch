From fde3bed0f400a50f31f1f6bcee44ac1b2c17ddc6 Mon Sep 17 00:00:00 2001
From: Albert Astals Cid <aacid@kde.org>
Date: Wed, 22 Feb 2012 00:03:37 +0100
Subject: [PATCH] pdfinfo: decode utf-16 surrogate pairs

Based on a patch by Adrian Johnson
Bug 23075
---
 utils/pdfinfo.cc |   14 ++++++++++++--
 1 file changed, 12 insertions(+), 2 deletions(-)

--- a/utils/pdfinfo.cc
+++ b/utils/pdfinfo.cc
@@ -14,8 +14,9 @@
 // under GPL version 2 or later
 //
 // Copyright (C) 2006 Dom Lachowicz <cinamod@hotmail.com>
-// Copyright (C) 2007-2010 Albert Astals Cid <aacid@kde.org>
+// Copyright (C) 2007-2010, 2012 Albert Astals Cid <aacid@kde.org>
 // Copyright (C) 2010 Hib Eris <hib@hiberis.nl>
+// Copyright (C) 2012 Adrian Johnson <ajohnson@redneon.com>
 //
 // To see a description of the changes please see the Changelog file that
 // came with your tarball or type make ChangeLog if you are building from git
@@ -347,7 +348,7 @@ static void printInfoString(Dict *infoDi
   Object obj;
   GooString *s1;
   GBool isUnicode;
-  Unicode u;
+  Unicode u, u2;
   char buf[8];
   int i, n;
 
@@ -367,6 +368,15 @@ static void printInfoString(Dict *infoDi
 	u = ((s1->getChar(i) & 0xff) << 8) |
 	    (s1->getChar(i+1) & 0xff);
 	i += 2;
+	if (u >= 0xd800 && u <= 0xdbff && i < obj.getString()->getLength()) {
+	  // surrogate pair
+	  u2 = ((s1->getChar(i) & 0xff) << 8) |
+	    (s1->getChar(i+1) & 0xff);
+	  i += 2;
+	  if (u2 >= 0xdc00 && u2 <= 0xdfff) {
+	    u = 0x10000 + ((u - 0xd800) << 10) + (u2 - 0xdc00);
+	  }
+	}
       } else {
 	u = pdfDocEncoding[s1->getChar(i) & 0xff];
 	++i;
