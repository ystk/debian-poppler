Fix patch for CVE-2017-14519

--- poppler-0.26.5.orig/poppler/Gfx.cc
+++ poppler-0.26.5/poppler/Gfx.cc
@@ -4000,30 +4000,32 @@ void Gfx::doShowText(GooString *s) {
 			       code, u, uLen)) {
 	((Gfx8BitFont *)font)->getCharProcNF(code, &charProc);
 	int refNum = -1;
+	Object charProc2;
 	if (charProc.isRef()) {
-		refNum = charProc.getRef().num;
+	  refNum = charProc.getRef().num;
+	  charProc.fetch(((Gfx8BitFont *)font)->getCharProcs()->getXRef(), &charProc2);
 	}
 	if ((resDict = ((Gfx8BitFont *)font)->getResources())) {
 	  pushResources(resDict);
 	}
-	if (charProc.isStream()) {
-		std::set<int>::iterator charProcDrawingIt;
-		bool displayCharProc = true;
-		if (refNum != -1) {
-			if (charProcDrawing.find(refNum) == charProcDrawing.end()) {
-				charProcDrawingIt = charProcDrawing.insert(refNum).first;
-			} else {
-				displayCharProc = false;
-				error(errSyntaxError, getPos(), "CharProc wants to draw a CharProc that is already beign drawn");
-			}
-		}
-		if (displayCharProc) {
-			display(&charProc, gFalse);
+	if (charProc2.isStream()) {
+	  std::set<int>::iterator charProcDrawingIt;
+	  bool displayCharProc = true;
+	  if (refNum != -1) {
+	    if (charProcDrawing.find(refNum) == charProcDrawing.end()) {
+	      charProcDrawingIt = charProcDrawing.insert(refNum).first;
+	    } else {
+	      displayCharProc = false;
+	      error(errSyntaxError, -1, "CharProc wants to draw a CharProc that is already beign drawn");
+	    }
+	  }
+	  if (displayCharProc) {
+	    display(&charProc2, gFalse);
 
-			if (refNum != -1) {
-				charProcDrawing.erase(charProcDrawingIt);
-			}
-		}
+	    if (refNum != -1) {
+	      charProcDrawing.erase(charProcDrawingIt);
+	    }
+	  }
 	} else {
 	  error(errSyntaxError, getPos(), "Missing or bad Type3 CharProc entry");
 	}
@@ -4031,6 +4033,7 @@ void Gfx::doShowText(GooString *s) {
 	if (resDict) {
 	  popResources();
 	}
+	charProc2.free();
 	charProc.free();
       }
       restoreStateStack(savedState);
